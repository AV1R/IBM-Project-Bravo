{% extends 'public/base.html' %}

{% block content %}

<nav class="d-flex justify-content-between" style="margin-left:20px; margin-right:20px;">
  <h1>Dashboard</h1>
  <a class="bx--btn bx--btn--primary" href="{% url 'add' %}">Add</a>
</nav>

  <hr />
  <div class="content">
    {% if error %}
      <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% endif %}


<!-- Nav pills -->
<ul class="nav nav-pills"  style="margin-left:20px; margin-right:20px;">
  {% for dsh in dashboards %}
    <li class="nav-item">
      <a class="bx--btn bx--btn--secondary {% if forloop.counter == 1 %}active {% endif %}" data-bs-toggle="pill" href="#dsh{{ dsh.id }}">{{ dsh.title }}</a>
    </li>
  {% endfor %}
</ul>

<!-- Tab panes -->
<div class="tab-content mt-1" style="background-color: #121619; width:100% !important;">
  {% for dsh in dashboards %}
  {% comment %} tab {% endcomment %}
  <div class="tab-pane container {% if forloop.counter == 1 %}show active{% endif %}" id="dsh{{ dsh.id }}" style="background-color: #121619 !important;">
      {% comment %} Charts {% endcomment %}

      {% comment %} ROW {% endcomment %}
      <div class="row m-5">
              {% comment %} Chart1 {% endcomment %}

          <div class="bx--grid col-xl-12 col-sm-12 col-md-12 p-0 text-start ">
              <div class="bx--row mt-5 mb-5" style="margin-right:-15px; border-radius: 0px;
              background: #1c1c1c;
              box-shadow:  5px 5px 10px #181818,
                          -5px -5px 10px #202020;">
                  <div class="bx--col-lg-16" style="width: 100%;">
                      <h1 class="bx--type-beta"></h1>
                      {{ dsh.chart_1div|safe }}
                  </div>
              </div>
            </div>
              {% comment %} ENDChart1 {% endcomment %}

              {% comment %} Chart2 {% endcomment %}

          <div class="bx--grid col-xl-4 col-sm-12 col-md-12  p-0 text-start">
            <div class="bx--row" style="margin-right:0px; border-radius: 0px;
                  background: #1c1c1c;
                box-shadow:  5px 5px 10px #181818,
             -5px -5px 10px #202020;">
                <div class="bx--col-lg-16" style="width: 100%;">
                    <h1 class="bx--type-beta"></h1>
                    {{ dsh.chart_2div|safe }}
                </div>
            </div>
          </div>
              {% comment %} ENDChart2 {% endcomment %}

              {% comment %} Chart3 {% endcomment %}

          <div class="bx--grid col-xl-4 col-sm-12 col-md-12  p-0 text-start">
            <div class="bx--row" style="margin-right:0px; border-radius: 0px;
                    background: #1c1c1c;
                    box-shadow:  5px 5px 10px #181818,
                    -5px -5px 10px #202020;">
                <div class="bx--col-lg-16" style="width: 100%;">
                    <h1 class="bx--type-beta"></h1>
                    {{ dsh.chart_3div|safe }}
                </div>
            </div>
          </div>
              {% comment %} ENDChart3 {% endcomment %}

              {% comment %} Chart4 {% endcomment %}

          <div class="bx--grid col-xl-4 col-sm-12 col-md-12  p-0 text-start">
            <div class="bx--row" style="border-radius: 0px;
                background: #1c1c1c;
                box-shadow:  5px 5px 10px #181818,
                -5px -5px 10px #202020;">
                <div class="bx--col-lg-16" style="width: 100%;">
                    <h1 class="bx--type-beta"></h1>
                    {{ dsh.chart_4div|safe }}
                </div>
            </div>
          </div>
              {% comment %} ENDChart4 {% endcomment %}

            {% comment %} Search here! {% endcomment %}
            <div class="bx--tile bg-dark text-secondary px-4 py-5 text-center mt-5" style="margin-bottom: 50px; width: 120%;">
              <div class="py-5">
                <h1 class="display-5 fw-bold text-white">Search</h1>
                <div class="col-lg-6 mx-auto">
                  <p class="fs-5 mb-4">Search by Certification name or UID</p>
                  <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    {% csrf_token %}  <!-- Include the CSRF token for security -->
                    <form method="" class="bx--form-control bx--form-control-dark" id="search-form">
                      <div class="bx--form-control bx--form-control-dark">
                        <div class="bx--row">
                          <div class="bx--col-10">
                            <input class="bx--text-input bx--text-input--light" name="search" type="text" placeholder="e.g. IBM Certified" aria-label="Search" />
                          </div>
                          <div class="bx--col-2">
                              <button  role="button" type="button" class="bx--btn bx--btn--primary bx--btn--field search-button" data-dsh="{{dsh.id}}">Search</button>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
                {% comment %} {% for dsh in dashboards %} {% endcomment %}
                  <div id="search-results-{{dsh.id}}" ></div>
                {% comment %} {% endfor %} {% endcomment %}
              </div>
           </div>
       </div>
       {% comment %} endROW {% endcomment %}
    </div>
  {% comment %} endtab {% endcomment %}

  {% endfor %}
</div>

</div>

<script>

  // Get all search buttons
  const searchButtons = document.querySelectorAll(".search-button");

  // Attach event listener to each search button
  searchButtons.forEach(button => {
    button.addEventListener("click", search);
  });
  //document.querySelector("#searchButton").addEventListener("click", search);

  // Handle search button click
  async function search(event) {
    event.preventDefault();
    const button = event.target;
    const dsh = button.getAttribute("data-dsh");
    console.log("Search works! Owner and dsh: ", dsh);
    console.log("target", document.querySelector("#search-form input[name='search']").value);
    // Create the search payload
    const payload = {
      "dsh": dsh,
      "target": document.querySelector("#search-form input[name='search']").value
    };
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    try {
      const response = await fetch("/search/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(payload)
      });
      console.log("After fetch")

      if (response.ok) {
        const data = await response.json();
        console.log("response ok")

        // Update the search results in the DOM
        if (data.table && data.table.length > 0) {
          let tableData = data.table;
          let tableHtml = "";

          // Generate HTML for the table
          if (tableData[0].type) {
            // Table with "type" field
            tableHtml += "<table class='bx--data-table bx--data-table--zebra'><thead><tr><th>Certification</th><th>Date</th><th>Type</th></tr></thead><tbody>";
            for (let i = 0; i < tableData.length; i++) {
              tableHtml += "<tr><td>" + tableData[i].certification + "</td><td>" + tableData[i].issue_date + "</td><td>" + tableData[i].type + "</td></tr>";
            }
            tableHtml += "</tbody></table>";
          } else if (tableData[0].org) {
            // Table with "org" field
            tableHtml += "<table class='bx--data-table bx--data-table--zebra'><thead><tr><th>UID</th><th>Certification</th><th>Organization</th><th>Date</th></tr></thead><tbody>";
            for (let i = 0; i < tableData.length; i++) {
              tableHtml += "<tr><td>" + tableData[i].uid + "</td><td>" + tableData[i].certification + "</td><td>" + tableData[i].org + "</td><td>" + tableData[i].issue_date + "</td></tr>";
            }
            tableHtml += "</tbody></table>";
          }

        document.getElementById(`search-results-${dsh}`).innerHTML = tableHtml;
      } else {
          console.log("no certificates")
        document.getElementById(`search-results-${dsh}`).innerHTML = "<div class='alert alert-danger' role='alert'>No certificates or employees found</div>";
        }
      } else {
        throw new Error("Error: " + response.status);
      }
    } catch (error) {
      console.log("response failed")

      console.error("Error: " + error);
    }
  }

</script>

{% endblock %}
